import { clientsClaim } from 'workbox-core';
import { precacheAndRoute, cleanupOutdatedCaches } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { NetworkOnly } from 'workbox-strategies';

self.skipWaiting();
clientsClaim();

// Precache all of the assets generated by your build process.
precacheAndRoute(self.__WB_MANIFEST);
cleanupOutdatedCaches();

// This route handler for videos is now corrected.
registerRoute(
  // This matching function now correctly ignores local blob: streams from WebTorrent.
  ({ request, url }) => {
    if (url.protocol === 'blob:') {
      return false;
    }
    return request.destination === 'video' || url.pathname.endsWith('.mp4') || url.pathname.endsWith('.webm');
  },
  // We now use a NetworkOnly strategy. This prevents the service worker
  // from caching video files, forcing the app to use the WebTorrent P2P
  // network as the primary delivery method.
  new NetworkOnly()
);
